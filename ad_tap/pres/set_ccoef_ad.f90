!        Generated by TAPENADE     (INRIA, Ecuador team)
!  tapenade 3.x
!
!  Differentiation of set_ccoef in reverse (adjoint) mode (with options noISIZE i8):
!   gradient     of useful results: *d *e *f *g *temp *propunit
!                *tsal *pres *a *b *c
!   with respect to varying inputs: *d *e *f *g *temp *propunit
!                *tsal *pres *a *b *c
!   Plus diff mem management of: d:in e:in f:in g:in temp:in propunit:in
!                tsal:in pres:in a:in b:in c:in
! MIT License
!
! Copyright (c) 2020 SHEMAT-Suite
!
! Permission is hereby granted, free of charge, to any person obtaining a copy
! of this software and associated documentation files (the "Software"), to deal
! in the Software without restriction, including without limitation the rights
! to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
! copies of the Software, and to permit persons to whom the Software is
! furnished to do so, subject to the following conditions:
!
! The above copyright notice and this permission notice shall be included in all
! copies or substantial portions of the Software.
!
! THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
! IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
! FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
! AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
! LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
! OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
! SOFTWARE.
!>    @brief calculate coefficents for the transport equation
!>    @param[in] spec species index
!>    @param[in] ismpl local sample index
!>    @details
!> calculate coefficents for the transport equation\n
!> coefficients are stored as vectors in the diagonals a-g (d center) and rhs in w.\n
SUBROUTINE SET_CCOEF_AD(spec, ismpl)
  use arrays

  USE ARRAYS_AD

  USE MOD_GENRL
  USE MOD_GENRLC
  USE MOD_FLOW
  USE MOD_CONC
  use mod_time

  USE MOD_TIME_AD

  USE MOD_LINFOS
  IMPLICIT NONE
  INTEGER :: i, j, k
  INTEGER :: ismpl
  EXTERNAL DI, DJ, DK, POR, VX, VY, &
&     VZ, ALFA
  EXTERNAL DI_AD, DJ_AD, DK_AD, VX_AD, VY_AD, VZ_AD, ALFA_AD
  DOUBLE PRECISION :: DI, DJ, DK, POR, VX, &
& VY, VZ, ALFA
  DOUBLE PRECISION :: v2, de, alf, p2
  DOUBLE PRECISION :: v2_ad, de_ad, alf_ad, p2_ad
  INTEGER :: spec
  DOUBLE PRECISION :: result1
  DOUBLE PRECISION :: result1_ad
  INTEGER :: arg1
!debug      write(99,'(a,3i4)') 'ShemSUITE i0,j0,k0:',i0,j0,k0
  DOUBLE PRECISION :: temporary_ad
  INTEGER :: branch
! inner points of grid - - - - - - - - - - - - - - - - - - - - - - - - -
  DO k=1,k0
    DO j=1,j0
      DO i=1,i0
        IF (i0 .GT. 1) THEN
          IF (i .LT. i0) THEN
            CALL PUSHREAL8(de)
            de = DI(i, j, k, spec, ismpl)
            result1 = VX(i, j, k, ismpl)
            CALL PUSHREAL8(v2)
            v2 = 0.5d0*result1
            IF (de .GT. 0.d0) THEN
              p2 = v2/de
              CALL PUSHREAL8(alf)
              alf = ALFA(p2)
              CALL PUSHCONTROL1B(0)
            ELSE
              CALL PUSHREAL8(alf)
              alf = 0.d0
              IF (v2 .LT. 0.d0) alf = -1.d0
              IF (v2 .GT. 0.d0) THEN
                CALL PUSHCONTROL1B(1)
                alf = 1.d0
              ELSE
                CALL PUSHCONTROL1B(1)
              END IF
            END IF
            CALL PUSHCONTROL1B(0)
          ELSE
            CALL PUSHCONTROL1B(1)
          END IF
          IF (i .GT. 1) THEN
            arg1 = i - 1
            CALL PUSHREAL8(de)
            de = DI(arg1, j, k, spec, ismpl)
            arg1 = i - 1
            result1 = VX(arg1, j, k, ismpl)
            CALL PUSHREAL8(v2)
            v2 = 0.5*result1
            CALL PUSHREAL8(alf)
            alf = 0.d0
            IF (v2 .EQ. 0.d0) THEN
              CALL PUSHCONTROL2B(0)
              alf = 0.d0
            ELSE IF (de .GT. 0.d0) THEN
              p2 = v2/de
              alf = ALFA(p2)
              CALL PUSHCONTROL2B(1)
            ELSE
              IF (v2 .LT. 0.d0) alf = -1.d0
              IF (v2 .GT. 0.d0) THEN
                CALL PUSHCONTROL2B(2)
                alf = 1.d0
              ELSE
                CALL PUSHCONTROL2B(2)
              END IF
            END IF
            CALL PUSHCONTROL2B(0)
          ELSE
            CALL PUSHCONTROL2B(1)
          END IF
        ELSE
          CALL PUSHCONTROL2B(2)
        END IF
        IF (j0 .GT. 1) THEN
          IF (j .LT. j0) THEN
            CALL PUSHREAL8(de)
            de = DJ(i, j, k, spec, ismpl)
            result1 = VY(i, j, k, ismpl)
            CALL PUSHREAL8(v2)
            v2 = 0.5*result1
            CALL PUSHREAL8(alf)
            alf = 0.d0
            IF (v2 .EQ. 0.d0) THEN
              CALL PUSHCONTROL2B(0)
              alf = 0.d0
            ELSE IF (de .GT. 0.d0) THEN
              p2 = v2/de
              alf = ALFA(p2)
              CALL PUSHCONTROL2B(1)
            ELSE
              IF (v2 .LT. 0.d0) alf = -1.d0
              IF (v2 .GT. 0.d0) THEN
                CALL PUSHCONTROL2B(2)
                alf = 1.d0
              ELSE
                CALL PUSHCONTROL2B(2)
              END IF
            END IF
            CALL PUSHCONTROL1B(0)
          ELSE
            CALL PUSHCONTROL1B(1)
          END IF
          IF (j .GT. 1) THEN
            arg1 = j - 1
            CALL PUSHREAL8(de)
            de = DJ(i, arg1, k, spec, ismpl)
            arg1 = j - 1
            result1 = VY(i, arg1, k, ismpl)
            CALL PUSHREAL8(v2)
            v2 = 0.5*result1
            CALL PUSHREAL8(alf)
            alf = 0.d0
            IF (v2 .EQ. 0.d0) THEN
              CALL PUSHCONTROL2B(0)
              alf = 0.d0
            ELSE IF (de .GT. 0.d0) THEN
              p2 = v2/de
              alf = ALFA(p2)
              CALL PUSHCONTROL2B(1)
            ELSE
              IF (v2 .LT. 0.d0) alf = -1.d0
              IF (v2 .GT. 0.d0) THEN
                CALL PUSHCONTROL2B(2)
                alf = 1.d0
              ELSE
                CALL PUSHCONTROL2B(2)
              END IF
            END IF
            CALL PUSHCONTROL2B(0)
          ELSE
            CALL PUSHCONTROL2B(1)
          END IF
        ELSE
          CALL PUSHCONTROL2B(2)
        END IF
        IF (k0 .GT. 1) THEN
          IF (k .LT. k0) THEN
            CALL PUSHREAL8(de)
            de = DK(i, j, k, spec, ismpl)
            result1 = VZ(i, j, k, ismpl)
            CALL PUSHREAL8(v2)
            v2 = 0.5d0*result1
            CALL PUSHREAL8(alf)
            alf = 0.d0
            IF (v2 .EQ. 0.d0) THEN
              CALL PUSHCONTROL2B(0)
              alf = 0.d0
            ELSE IF (de .GT. 0.d0) THEN
              p2 = v2/de
              alf = ALFA(p2)
              CALL PUSHCONTROL2B(1)
            ELSE
              IF (v2 .LT. 0.d0) alf = -1.d0
              IF (v2 .GT. 0.d0) THEN
                CALL PUSHCONTROL2B(2)
                alf = 1.d0
              ELSE
                CALL PUSHCONTROL2B(2)
              END IF
            END IF
            CALL PUSHCONTROL1B(0)
          ELSE
            CALL PUSHCONTROL1B(1)
          END IF
          IF (k .GT. 1) THEN
            arg1 = k - 1
            CALL PUSHREAL8(de)
            de = DK(i, j, arg1, spec, ismpl)
            arg1 = k - 1
            result1 = VZ(i, j, arg1, ismpl)
            CALL PUSHREAL8(v2)
            v2 = 0.5d0*result1
            CALL PUSHREAL8(alf)
            alf = 0.d0
            IF (v2 .EQ. 0.d0) THEN
              CALL PUSHCONTROL2B(0)
              alf = 0.d0
            ELSE IF (de .GT. 0.d0) THEN
              p2 = v2/de
              alf = ALFA(p2)
              CALL PUSHCONTROL2B(1)
            ELSE
              IF (v2 .LT. 0.d0) alf = -1.d0
              IF (v2 .GT. 0.d0) THEN
                CALL PUSHCONTROL2B(2)
                alf = 1.d0
              ELSE
                CALL PUSHCONTROL2B(2)
              END IF
            END IF
            CALL PUSHCONTROL2B(2)
          ELSE
            CALL PUSHCONTROL2B(1)
          END IF
        ELSE
          CALL PUSHCONTROL2B(0)
        END IF
      END DO
    END DO
  END DO
  DO k=k0,1,-1
    DO j=j0,1,-1
      DO 110 i=i0,1,-1
        CALL POPCONTROL2B(branch)
        IF (branch .NE. 0) THEN
          IF (branch .NE. 1) THEN
            temporary_ad = -(d_ad(i, j, k, ismpl)/delz(k))
            de_ad = temporary_ad
            alf_ad = v2*temporary_ad
            v2_ad = -((1.d0-alf)*temporary_ad)
            temporary_ad = a_ad(i, j, k, ismpl)/delz(k)
            a_ad(i, j, k, ismpl) = 0.D0
            de_ad = de_ad + temporary_ad
            alf_ad = alf_ad + v2*temporary_ad
            v2_ad = v2_ad + (alf+1.d0)*temporary_ad
            CALL POPCONTROL2B(branch)
            IF (branch .NE. 0) THEN
              IF (branch .EQ. 1) THEN
                p2 = v2/de
                CALL ALFA_AD(p2, p2_ad, alf_ad)
                v2_ad = v2_ad + p2_ad/de
                de_ad = de_ad - v2*p2_ad/de**2
              END IF
            END IF
            CALL POPREAL8(alf)
            CALL POPREAL8(v2)
            result1_ad = 0.5d0*v2_ad
            arg1 = k - 1
            CALL VZ_AD(i, j, arg1, ismpl, result1_ad)
            arg1 = k - 1
            CALL POPREAL8(de)
            CALL DK_AD(i, j, arg1, spec, ismpl, de_ad)
          END IF
          CALL POPCONTROL1B(branch)
          IF (branch .EQ. 0) THEN
            temporary_ad = -(d_ad(i, j, k, ismpl)/delz(k))
            de_ad = temporary_ad
            alf_ad = v2*temporary_ad
            v2_ad = (alf+1.d0)*temporary_ad
            temporary_ad = g_ad(i, j, k, ismpl)/delz(k)
            g_ad(i, j, k, ismpl) = 0.D0
            de_ad = de_ad + temporary_ad
            alf_ad = alf_ad + v2*temporary_ad
            v2_ad = v2_ad - (1.d0-alf)*temporary_ad
            CALL POPCONTROL2B(branch)
            IF (branch .NE. 0) THEN
              IF (branch .EQ. 1) THEN
                p2 = v2/de
                CALL ALFA_AD(p2, p2_ad, alf_ad)
                v2_ad = v2_ad + p2_ad/de
                de_ad = de_ad - v2*p2_ad/de**2
              END IF
            END IF
            CALL POPREAL8(alf)
            CALL POPREAL8(v2)
            result1_ad = 0.5d0*v2_ad
            CALL VZ_AD(i, j, k, ismpl, result1_ad)
            CALL POPREAL8(de)
            CALL DK_AD(i, j, k, spec, ismpl, de_ad)
          END IF
        END IF
        CALL POPCONTROL2B(branch)
        IF (branch .EQ. 0) THEN
          temporary_ad = -(d_ad(i, j, k, ismpl)/dely(j))
          de_ad = temporary_ad
          alf_ad = v2*temporary_ad
          v2_ad = -((1.d0-alf)*temporary_ad)
          temporary_ad = b_ad(i, j, k, ismpl)/dely(j)
          b_ad(i, j, k, ismpl) = 0.D0
          de_ad = de_ad + temporary_ad
          alf_ad = alf_ad + v2*temporary_ad
          v2_ad = v2_ad + (alf+1.d0)*temporary_ad
          CALL POPCONTROL2B(branch)
          IF (branch .NE. 0) THEN
            IF (branch .EQ. 1) THEN
              p2 = v2/de
              CALL ALFA_AD(p2, p2_ad, alf_ad)
              v2_ad = v2_ad + p2_ad/de
              de_ad = de_ad - v2*p2_ad/de**2
            END IF
          END IF
          CALL POPREAL8(alf)
          CALL POPREAL8(v2)
          result1_ad = 0.5*v2_ad
          arg1 = j - 1
          CALL VY_AD(i, arg1, k, ismpl, result1_ad)
          arg1 = j - 1
          CALL POPREAL8(de)
          CALL DJ_AD(i, arg1, k, spec, ismpl, de_ad)
        ELSE IF (branch .NE. 1) THEN
          GOTO 100
        END IF
        CALL POPCONTROL1B(branch)
        IF (branch .EQ. 0) THEN
          temporary_ad = -(d_ad(i, j, k, ismpl)/dely(j))
          de_ad = temporary_ad
          alf_ad = v2*temporary_ad
          v2_ad = (alf+1.d0)*temporary_ad
          temporary_ad = f_ad(i, j, k, ismpl)/dely(j)
          f_ad(i, j, k, ismpl) = 0.D0
          de_ad = de_ad + temporary_ad
          alf_ad = alf_ad + v2*temporary_ad
          v2_ad = v2_ad - (1.d0-alf)*temporary_ad
          CALL POPCONTROL2B(branch)
          IF (branch .NE. 0) THEN
            IF (branch .EQ. 1) THEN
              p2 = v2/de
              CALL ALFA_AD(p2, p2_ad, alf_ad)
              v2_ad = v2_ad + p2_ad/de
              de_ad = de_ad - v2*p2_ad/de**2
            END IF
          END IF
          CALL POPREAL8(alf)
          CALL POPREAL8(v2)
          result1_ad = 0.5*v2_ad
          CALL VY_AD(i, j, k, ismpl, result1_ad)
          CALL POPREAL8(de)
          CALL DJ_AD(i, j, k, spec, ismpl, de_ad)
        END IF
 100    CALL POPCONTROL2B(branch)
        IF (branch .EQ. 0) THEN
          temporary_ad = -(d_ad(i, j, k, ismpl)/delx(i))
          de_ad = temporary_ad
          alf_ad = v2*temporary_ad
          v2_ad = -((1.d0-alf)*temporary_ad)
          temporary_ad = c_ad(i, j, k, ismpl)/delx(i)
          c_ad(i, j, k, ismpl) = 0.D0
          de_ad = de_ad + temporary_ad
          alf_ad = alf_ad + v2*temporary_ad
          v2_ad = v2_ad + (alf+1.d0)*temporary_ad
          CALL POPCONTROL2B(branch)
          IF (branch .NE. 0) THEN
            IF (branch .EQ. 1) THEN
              p2 = v2/de
              CALL ALFA_AD(p2, p2_ad, alf_ad)
              v2_ad = v2_ad + p2_ad/de
              de_ad = de_ad - v2*p2_ad/de**2
            END IF
          END IF
          CALL POPREAL8(alf)
          CALL POPREAL8(v2)
          result1_ad = 0.5*v2_ad
          arg1 = i - 1
          CALL VX_AD(arg1, j, k, ismpl, result1_ad)
          arg1 = i - 1
          CALL POPREAL8(de)
          CALL DI_AD(arg1, j, k, spec, ismpl, de_ad)
        ELSE IF (branch .NE. 1) THEN
          GOTO 110
        END IF
        CALL POPCONTROL1B(branch)
        IF (branch .EQ. 0) THEN
          temporary_ad = -(d_ad(i, j, k, ismpl)/delx(i))
          de_ad = temporary_ad
          alf_ad = v2*temporary_ad
          v2_ad = (alf+1.d0)*temporary_ad
          temporary_ad = e_ad(i, j, k, ismpl)/delx(i)
          e_ad(i, j, k, ismpl) = 0.D0
          de_ad = de_ad + temporary_ad
          alf_ad = alf_ad + v2*temporary_ad
          v2_ad = v2_ad - (1.d0-alf)*temporary_ad
          CALL POPCONTROL1B(branch)
          IF (branch .EQ. 0) THEN
            p2 = v2/de
            CALL POPREAL8(alf)
            CALL ALFA_AD(p2, p2_ad, alf_ad)
            v2_ad = v2_ad + p2_ad/de
            de_ad = de_ad - v2*p2_ad/de**2
          ELSE
            CALL POPREAL8(alf)
          END IF
          CALL POPREAL8(v2)
          result1_ad = 0.5d0*v2_ad
          CALL VX_AD(i, j, k, ismpl, result1_ad)
          CALL POPREAL8(de)
          CALL DI_AD(i, j, k, spec, ismpl, de_ad)
        END IF
 110  CONTINUE
    END DO
  END DO
END SUBROUTINE SET_CCOEF_AD

