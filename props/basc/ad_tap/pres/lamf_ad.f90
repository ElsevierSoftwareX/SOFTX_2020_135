!        Generated by TAPENADE     (INRIA, Ecuador team)
!  tapenade 3.x
!
!  Differentiation of lamf in reverse (adjoint) mode (with options noISIZE i8):
!   gradient     of useful results: *temp *tsal lamf
!   with respect to varying inputs: *temp *tsal
!   Plus diff mem management of: temp:in tsal:in pres:in
! MIT License
!
! Copyright (c) 2020 SHEMAT-Suite
!
! Permission is hereby granted, free of charge, to any person obtaining a copy
! of this software and associated documentation files (the "Software"), to deal
! in the Software without restriction, including without limitation the rights
! to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
! copies of the Software, and to permit persons to whom the Software is
! furnished to do so, subject to the following conditions:
!
! The above copyright notice and this permission notice shall be included in all
! copies or substantial portions of the Software.
!
! THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
! IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
! FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
! AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
! LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
! OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
! SOFTWARE.
!> @brief calculate the thermal conductivity kf of fluid [W/(m*K)]
!> @param[in] i cell index, direction I0
!> @param[in] j cell index, direction J0
!> @param[in] k cell index, direction K0
!> @param[in] ismpl local sample index
!> @return  thermal conductivity                lamf[W/(m*K)]
!> @details
!> calculate the thermal conductivity kf in W/(m*K) of saline water,
!> given temperature in degC, and salinity in mass fraction (g/g)of
!> NaCl. Thermal conductivity of freshwater, kfw is calculated using
!> the Phillips (1981) formulation (page8). \n \n
!>
!>      C = S./(1 + S)*1.d2;C2=C.*C;    % C=salinity in mol/kg \n\n
!>    kf = kfw.*(1.d0 - (2.3434d-3 - 7.924d-6*T + 3.924d-8*T2).*C ... \n
!>                         + (1.06d-5 - 2.d-8*T - 1.2d-10*T2).*C2) \n\n
!> Source:\n\n
!>
!> Phillips, S., Igbene, A., Fair, J., Ozbek, H., & Tavana, M.,
!> Technical databook for geothermal energy utilization (1981).
!> http://dx.doi.org/10.2172/6301274 \n\n
!>
!> Range of validity:  20 to 330degC and up to 4 molal NaCl\n\n
!> input:\n
!> pressure                             p [MPa]\n
!> temperature                          t in [C]\n
!> salinity                              s in [mol/L]\n
SUBROUTINE LAMF_AD0(i, j, k, ismpl, lamf_ad)
  use arrays

  USE ARRAYS_AD

  USE MOD_FLOW
  IMPLICIT NONE
! Location indices
  INTEGER, INTENT(IN) :: i
  INTEGER, INTENT(IN) :: j
  INTEGER, INTENT(IN) :: k
! Sample index
  INTEGER :: ismpl
! Local Temperature (degC)
  DOUBLE PRECISION :: t
  DOUBLE PRECISION :: t_ad
! Local Pressure (MPa)
  DOUBLE PRECISION :: p
! Local salinity [mol/kg / mol/L]
  DOUBLE PRECISION :: s
  DOUBLE PRECISION :: s_ad
! Monomials of temperature
  DOUBLE PRECISION :: t2, t3, t4
  DOUBLE PRECISION :: t2_ad
! Salinity from Phillips1981 [-]
  DOUBLE PRECISION :: sr
  DOUBLE PRECISION :: sr_ad
! Monomial of salinity from Phillips1981 [-]
  DOUBLE PRECISION :: sr2
  DOUBLE PRECISION :: sr2_ad
! Factor for thermal conductivity, Phillips1981 (2)
  DOUBLE PRECISION :: lamfac
  DOUBLE PRECISION :: lamfac_ad
! Pure water thermal conductivity [W/(m*K)]
  DOUBLE PRECISION, EXTERNAL :: LAMW
  DOUBLE PRECISION :: result1
  DOUBLE PRECISION :: result1_ad
  DOUBLE PRECISION :: temporary_ad
  DOUBLE PRECISION :: lamf
  DOUBLE PRECISION :: lamf_ad
! Local pressure [MPa]
! Local temperature [degC]
  t = temp(i, j, k, ismpl)
! Local salinity [mol/L / mol/kg]
  s = tsal(i, j, k, ismpl)
  IF (s .LE. 0.0d0) THEN
    CALL LAMW_AD0(p, t, t_ad, lamf_ad)
    s_ad = 0.D0
  ELSE
! Salinity according to Phillips (1981) between (2) and (3)
    sr = 5844.3d0*s/(1.0d3+58.443d0*s)
! Monomials in salinity and temperature
    sr2 = sr*sr
    t2 = t*t
! Factor lamf/lamw from Phillips1981, eq (2)
    lamfac = 1.0d0 - (2.3434d-3-7.924d-6*t+3.924d-8*t2)*sr + (1.06d-5-&
&     2.0d-8*t+1.2d-10*t2)*sr2
! Thermal conductivity of fluid
    result1 = LAMW(p, t)
    lamfac_ad = result1*lamf_ad
    result1_ad = lamfac*lamf_ad
    CALL LAMW_AD0(p, t, t_ad, result1_ad)
    t2_ad = (1.2d-10*sr2-3.924d-8*sr)*lamfac_ad
    t_ad = t_ad + (7.924d-6*sr-2.0d-8*sr2)*lamfac_ad + 2*t*t2_ad
    sr2_ad = (1.2d-10*t2-2.0d-8*t+1.06d-5)*lamfac_ad
    sr_ad = 2*sr*sr2_ad - (3.924d-8*t2-7.924d-6*t+2.3434d-3)*lamfac_ad
    temporary_ad = 5844.3d0*sr_ad/(58.443d0*s+1.0d3)
    s_ad = (1.0-58.443d0*s/(58.443d0*s+1.0d3))*temporary_ad
  END IF
  tsal_ad(i, j, k, ismpl) = tsal_ad(i, j, k, ismpl) + s_ad
  temp_ad(i, j, k, ismpl) = temp_ad(i, j, k, ismpl) + t_ad
END SUBROUTINE LAMF_AD0

