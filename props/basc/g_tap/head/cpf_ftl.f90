!        Generated by TAPENADE     (INRIA, Ecuador team)
!  tapenade 3.x
!
!  Differentiation of cpf in forward (tangent) mode:
!   variations   of useful results: cpf
!   with respect to varying inputs: *temp *tsal *pres
!   Plus diff mem management of: temp:in tsal:in pres:in
! MIT License
!
! Copyright (c) 2020 SHEMAT-Suite
!
! Permission is hereby granted, free of charge, to any person obtaining a copy
! of this software and associated documentation files (the "Software"), to deal
! in the Software without restriction, including without limitation the rights
! to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
! copies of the Software, and to permit persons to whom the Software is
! furnished to do so, subject to the following conditions:
!
! The above copyright notice and this permission notice shall be included in all
! copies or substantial portions of the Software.
!
! THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
! IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
! FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
! AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
! LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
! OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
! SOFTWARE.
!> @brief cpf(i,j,k,ismpl) calculates the isobaric heat capacity of the fluid [J/kg/K]
!> @param[in] i cell index, direction I0
!> @param[in] j cell index, direction J0
!> @param[in] k cell index, direction K0
!> @param[in] ismpl local sample index
!> @return cpf  [J/kg/K]
!> @details
!> cpf(i,j,k,ismpl) calculates the isobaric heat capacity in (in
!> J/kg/K) of brine, given temperature (t, in degC) pressure (p,in MPa),
!> and salinity (s, in mol/L) at node(i,j,k)\\n \n
!>
!> Source:\n
!> Driesner & Heinrich, The system H2O-NaCl. Part I: Correlation
!>    formulae for phase relations in temperature-pressure-composition
!>    space from 0 to 1000 C, 0 to 5000 bar, and 0 to 1 XNaCl
!>    Geochimica et Cosmochimica Acta 71 (2007) 4880-4901\n\n
!>
!> Driesner, The system H2O-NaCl. Part II: Correlations for molar
!>    volume, enthalpy, and isobaric heat capacity from 0 to 1000 C, 1
!>    to 5000 bar, and 0 to 1 XNaCl Geochimica et Cosmochimica Acta 71
!>    (2007) 4902-4919\n \n
DOUBLE PRECISION FUNCTION g_CPF(i, j, k, ismpl, cpf)
  USE ARRAYS

  USE g_ARRAYS

  USE MOD_FLOW
  IMPLICIT NONE
! Location indices
  INTEGER, INTENT(IN) :: i
  INTEGER, INTENT(IN) :: j
  INTEGER, INTENT(IN) :: k
! Sample index
  INTEGER :: ismpl
! Local Temperature, [degC]
  DOUBLE PRECISION :: t
  DOUBLE PRECISION :: g_t
! Local Pressure [MPa]
  DOUBLE PRECISION :: p
  DOUBLE PRECISION :: g_p
! Local salinity [mol/kg]
  DOUBLE PRECISION :: s
  DOUBLE PRECISION :: g_s
! Monomials of pressure [bar]
  DOUBLE PRECISION :: pb, pb2
  DOUBLE PRECISION :: g_pb, g_pb2
! Pure water compressibility [1/Pa]
  DOUBLE PRECISION :: cw
  DOUBLE PRECISION, EXTERNAL :: COMPW
! Pure water density [kg/m3]
  DOUBLE PRECISION :: rw
  DOUBLE PRECISION :: g_rw
  DOUBLE PRECISION, EXTERNAL :: RHOW
! Pure water thermal conductivity [J/kg/K]
  DOUBLE PRECISION, EXTERNAL :: CPW
	double precision, external :: g_rhow
	double precision, external :: g_cpw
! Molar mass of NaCl [g/mol]
  DOUBLE PRECISION, PARAMETER :: mmnacl=58.44277d0
! Mass fraction of NaCl in solution [-]
  DOUBLE PRECISION :: fracnacl
  DOUBLE PRECISION :: g_fracnacl
! Molar mass of water, H2O [g/mol]
  DOUBLE PRECISION, PARAMETER :: mmwater=18.01528d0
! Mole fraction of NaCl [-]
  DOUBLE PRECISION :: xnacl
  DOUBLE PRECISION :: g_xnacl
! Temperature at which pure water has the same specific
! enthalpy as the solution [K]
  DOUBLE PRECISION :: tv
  DOUBLE PRECISION :: g_tv
! Driesner2007: Coefficients
! Equation (23)
  DOUBLE PRECISION :: q1, q10, q11, q12
  DOUBLE PRECISION :: g_q1, g_q10, g_q11, g_q12
! Equation (24)
  DOUBLE PRECISION :: q2, q20, q21, q22, q23
  DOUBLE PRECISION :: g_q2, g_q20, g_q21, g_q22, g_q23
! Equation (25), (26)
  DOUBLE PRECISION :: q1x, q2x
  DOUBLE PRECISION :: g_q1x, g_q2x
  INTRINSIC SQRT
  DOUBLE PRECISION :: result1
  DOUBLE PRECISION :: g_result1
  DOUBLE PRECISION :: temp0
  DOUBLE PRECISION :: cpf
! Local temperature [degC]
  g_t = g_temp(i, j, k, ismpl)
  t = temp(i, j, k, ismpl)
! Local pressure [MPa]
  g_p = pa_conv1*g_pres(i, j, k, ismpl)
  p = pres(i, j, k, ismpl)*pa_conv1
! Local salinity [mol/L]
  g_s = g_tsal(i, j, k, ismpl)
  s = tsal(i, j, k, ismpl)
  IF (s .LE. 0.0d0) THEN
! Pure water heat capacity
    g_cpf = g_CPW(p, g_p, t, g_t, cpf)
  ELSE
! pure water density [g/L = kg/m3]
    g_rw = g_RHOW(p, g_p, t, g_t, rw)
! Pressure monomials [bar]
    g_pb = 10.0d0*g_p
    pb = p*10.0d0
    g_pb2 = 2*pb*g_pb
    pb2 = pb*pb
! Mass fraction of NaCl, mol/L > (g/L) / (g/L) mass fraction
    temp0 = s/(rw+mmnacl*s)
    g_fracnacl = mmnacl*(g_s-temp0*(g_rw+mmnacl*g_s))/(rw+mmnacl&
&     *s)
    fracnacl = mmnacl*temp0
! Mole fraction of NaCl, (mol/L) / (mol/L)
    temp0 = mmnacl*(fracnacl/mmnacl+(-fracnacl+1)/mmwater)
    g_xnacl = (1.0-fracnacl*mmnacl*(1.0/mmnacl-1.0/mmwater)/temp0)*&
&     g_fracnacl/temp0
    xnacl = fracnacl/temp0
! Driesner2007 parameters, Table 5
    g_q11 = 0.0621255d0*g_pb
    q11 = -32.1724d0 + 0.0621255d0*pb
    g_q21 = -(6.04279d-8*g_pb2) - 4.52781d-4*g_pb
    q21 = -1.69513d0 - 4.52781d-4*pb - 6.04279d-8*pb2
    g_q22 = 1.88082d-5*g_pb
    q22 = 0.0612567d0 + 1.88082d-5*pb
! Driesner2007: q1 and q2 parameters for liquid NaCl
    g_q1x = 6.51059d-6*g_pb2 - 9.36994d-3*g_pb
    q1x = 47.9048d0 - 9.36994d-3*pb + 6.51059d-6*pb2
    g_q2x = 3.45087d-5*g_pb - 4.28356d-9*g_pb2
    q2x = 0.241022d0 + 3.45087d-5*pb - 4.28356d-9*pb2
! Driesner2007: Set xnacl=1 in (23) => q1 = q1x
    g_q10 = g_q1x
    q10 = q1x
! Driesner2007: Set xnacl=0 in (23) => q1 = 0.0d0
    g_q12 = -g_q10 - g_q11
    q12 = -q10 - q11
! Driesner2007: Set xnacl=0 in (24) => q2 = 1.0d0
    temp0 = SQRT(q22)
    IF (q22 .EQ. 0.0) THEN
      g_result1 = 0.D0
    ELSE
      g_result1 = g_q22/(2.0*temp0)
    END IF
    result1 = temp0
    g_q20 = -(result1*g_q21+q21*g_result1)
    q20 = 1.0d0 - q21*result1
! Driesner2007: Set xnacl=1 in (10) => q2 = q2x
    temp0 = SQRT(q22 + 1.0d0)
    IF (q22 + 1.0d0 .EQ. 0.0) THEN
      g_result1 = 0.D0
    ELSE
      g_result1 = g_q22/(2.0*temp0)
    END IF
    result1 = temp0
    g_q23 = g_q2x - g_q20 - result1*g_q21 - q21*g_result1
    q23 = q2x - q20 - q21*result1
! Driesner2007: Equation (23)
    g_q1 = g_q10 + (1.0d0-xnacl)*g_q11 - (q11+q12*2*(1.0d0-xnacl))&
&     *g_xnacl + (1.0d0-xnacl)**2*g_q12
    q1 = q10 + q11*(1.0d0-xnacl) + q12*(1.0d0-xnacl)**2
! Driesner2007: Equation (24)
    temp0 = SQRT(xnacl + q22)
    IF (xnacl + q22 .EQ. 0.0) THEN
      g_result1 = 0.D0
    ELSE
      g_result1 = (g_xnacl+g_q22)/(2.0*temp0)
    END IF
    result1 = temp0
    g_q2 = g_q20 + result1*g_q21 + q21*g_result1 + xnacl*g_q23&
&     + q23*g_xnacl
    q2 = q20 + q21*result1 + q23*xnacl
! Temperature at which pure water has the same specific
! enthalpy as the solution
    g_tv = g_q1 + t*g_q2 + q2*g_t
    tv = q1 + q2*t
! Isobaric heat capacity of solution
    g_result1 = g_CPW(p, g_p, tv, g_tv, result1)
    g_cpf = result1*g_q2 + q2*g_result1
    cpf = q2*result1
  END IF
  RETURN
END FUNCTION g_CPF

