!        Generated by TAPENADE     (INRIA, Ecuador team)
!  tapenade 3.x
!
!>    @brief reinjection routine
!>    @param[in] ismpl local sample index
!>    @details
!>injection 1   13       8         5\n
!>injection 2   13       8        13\n
!>injection 3   13       8        21\n
!>production 1  13       18        5\n
!>production 2  13       18       13\n
!>production 3  13       18       21\n
SUBROUTINE g_calc_user(ismpl)
  USE ARRAYS

  USE g_ARRAYS

  USE MOD_GENRL
  USE MOD_TIME

  USE g_MOD_TIME

  USE MOD_LINFOS
  USE MOD_WELLS3D
  IMPLICIT NONE
  INTEGER :: ismpl
  INTEGER :: i, j
  DOUBLE PRECISION :: tempc, pumpc, tempt, deltt
  LOGICAL :: lbc_found, lbc_found1, lbc_found2
  EXTERNAL DELTAT
  DOUBLE PRECISION :: DELTAT
  INTRINSIC DABS
  DOUBLE PRECISION :: dabs0
  DOUBLE PRECISION :: dabs1
  DOUBLE PRECISION :: dabs2
  IF (linfos(3) .GE. 2) WRITE(*, *) ' ... calc_user (REINJECT-3D)'
!VR --- special case, danger !!! ---
  deltt = DELTAT(simtime(ismpl), ismpl)
  IF ((simtime(ismpl)+deltt)/tunit .GE. stoptime) THEN
    tempc = 0.d0
    pumpc = 0.d0
    tempt = 0.d0
!       for all productions
    DO j=1,num_pro
      lbc_found = .false.
!          search in all boundary condition
      DO i=1,nbc_data
        IF (ibc_data(i, cbc_i) .EQ. ipro(j) .AND. ibc_data(i, cbc_j) &
&           .EQ. jpro(j) .AND. ibc_data(i, cbc_k) .EQ. kpro(j) .AND. &
&           ibc_data(i, cbc_pv) .EQ. pv_head .AND. ibc_data(i, cbc_bt) &
&           .EQ. bt_neum) THEN
          IF (dbc_data(i, 1, ismpl) .GE. 0.d0) THEN
            WRITE(*, '(2A,3I8,1A)') 'error: HEAD Neumann-boundary', &
&           ' point for production', ' has a value >= 0.0 at [', ipro(j)&
&           , jpro(j), kpro(j), '] !'
            STOP
          ELSE
            lbc_found = .true.
            IF (dbc_data(i, 1, ismpl) .GE. 0.) THEN
              dabs0 = dbc_data(i, 1, ismpl)
            ELSE
              dabs0 = -dbc_data(i, 1, ismpl)
            END IF
            tempc = tempc + conc(ipro(j), jpro(j), kpro(j), 1, ismpl)*&
&             dabs0
            IF (dbc_data(i, 1, ismpl) .GE. 0.) THEN
              dabs1 = dbc_data(i, 1, ismpl)
            ELSE
              dabs1 = -dbc_data(i, 1, ismpl)
            END IF
            tempt = tempt + temp(ipro(j), jpro(j), kpro(j), ismpl)*dabs1
            IF (dbc_data(i, 1, ismpl) .GE. 0.) THEN
              dabs2 = dbc_data(i, 1, ismpl)
            ELSE
              dabs2 = -dbc_data(i, 1, ismpl)
            END IF
            pumpc = pumpc + dabs2
            WRITE(*, '(1A,3(e12.4))') '!!!!! GPK2 center ', conc(ipro(j)&
&           , jpro(j), kpro(j), 1, ismpl), temp(ipro(j), jpro(j), kpro(j&
&           ), ismpl), dbc_data(i, 1, ismpl)
          END IF
        END IF
      END DO
      IF (.NOT.lbc_found) THEN
        WRITE(*, '(1A,3I8,1A)') 'error: no HEAD Neumann-boundary ', &
&       'point found for production [', ipro(j), jpro(j), kpro(j), '] !'
        STOP
      END IF
    END DO
    IF (pumpc .NE. 0.d0) THEN
      tempc = tempc/pumpc
      tempt = tempt/pumpc
    END IF
    WRITE(*, '(4(1A,1e12.4))') '!!!!! reinjection rate = ', pumpc, &
&   ' l/s,   concentration = ', tempc, ' mmol/l, temperature = ', tempt&
&   , ' C, time =', simtime(ismpl)
!       for all sources
    DO j=1,num_in
      lbc_found = .false.
      lbc_found1 = .false.
      lbc_found2 = .false.
!          search in all boundary condition
      DO i=1,nbc_data
        IF (ibc_data(i, cbc_i) .EQ. iin(j) .AND. ibc_data(i, cbc_j) .EQ.&
&           jin(j) .AND. ibc_data(i, cbc_k) .EQ. kin(j) .AND. ibc_data(i&
&           , cbc_pv) .EQ. pv_conc .AND. ibc_data(i, cbc_bt) .EQ. &
&           bt_diri .AND. ibc_data(i, cbc_si) .EQ. 1) THEN
          dbc_data(i, 1, ismpl) = tempc
          lbc_found = .true.
        END IF
        IF (ibc_data(i, cbc_i) .EQ. iin(j) .AND. ibc_data(i, cbc_j) .EQ.&
&           jin(j) .AND. ibc_data(i, cbc_k) .EQ. kin(j) .AND. ibc_data(i&
&           , cbc_pv) .EQ. pv_temp .AND. ibc_data(i, cbc_bt) .EQ. &
&           bt_diri) THEN
          dbc_data(i, 1, ismpl) = tempt
          lbc_found1 = .true.
        END IF
        IF (ibc_data(i, cbc_i) .EQ. iin(j) .AND. ibc_data(i, cbc_j) .EQ.&
&           jin(j) .AND. ibc_data(i, cbc_k) .EQ. kin(j) .AND. ibc_data(i&
&           , cbc_pv) .EQ. pv_head .AND. ibc_data(i, cbc_bt) .EQ. &
&           bt_neum) THEN
          dbc_data(i, 1, ismpl) = pumpc
          lbc_found2 = .true.
        END IF
      END DO
      IF (.NOT.lbc_found) THEN
        WRITE(*, '(1A,3I8,1A)') 'error: no CONC Dirichlet-boundar', &
&       'y point found for injection [', iin(j), jin(j), kin(j), '] !'
        STOP
      ELSE IF (.NOT.lbc_found1) THEN
        WRITE(*, '(1A,3I8,1A)') 'error: no TEMP Dirichlet-boundar', &
&       'y point found for injection [', iin(j), jin(j), kin(j), '] !'
        STOP
      ELSE IF (.NOT.lbc_found2) THEN
        WRITE(*, '(1A,3I8,1A)') 'error: no HEAD Dirichlet-boundar', &
&       'y point found for injection [', iin(j), jin(j), kin(j), '] !'
        STOP
      END IF
    END DO
  ELSE
!       reset the initial values
    DO i=1,nbc_data
      dbc_data(i, 1, ismpl) = dbc_dataold(i)
    END DO
  END IF
!VR --- special case, danger !!! ---
  RETURN
END SUBROUTINE g_calc_user

